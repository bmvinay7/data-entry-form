<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Setup Verification Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 { color: #2563eb; margin-bottom: 10px; }
        .subtitle { color: #6b7280; margin-bottom: 30px; }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }
        input[type="url"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
        }
        input[type="url"]:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover { background: #1d4ed8; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .success {
            background: #ecfdf5;
            border-color: #10b981;
            color: #065f46;
        }
        .error {
            background: #fef2f2;
            border-color: #ef4444;
            color: #991b1b;
        }
        .warning {
            background: #fffbeb;
            border-color: #f59e0b;
            color: #92400e;
        }
        .info {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #1e40af;
        }
        .code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
        }
        .step {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .step h3 {
            margin-top: 0;
            color: #1e293b;
        }
        .checklist {
            list-style: none;
            padding: 0;
        }
        .checklist li {
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .checklist li:last-child {
            border-bottom: none;
        }
        .check { color: #10b981; font-weight: bold; }
        .cross { color: #ef4444; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Setup Verification Tool</h1>
        <p class="subtitle">This tool helps you verify that your Google Apps Script is properly configured and working without CORS errors.</p>

        <div class="input-group">
            <label for="scriptUrl">Google Apps Script Web App URL:</label>
            <input type="url" id="scriptUrl" placeholder="https://script.google.com/macros/s/AKfycbx.../exec">
            <small style="color: #6b7280; display: block; margin-top: 5px;">
                Paste your Web App URL here (should end with /exec)
            </small>
        </div>

        <div>
            <button class="btn" onclick="testConnection()">üîó Test Connection</button>
            <button class="btn" onclick="testSubmission()">üìù Test Form Submission</button>
            <button class="btn" onclick="runFullTest()">üöÄ Run Full Test</button>
        </div>

        <div id="results"></div>

        <div class="step">
            <h3>üìã Setup Checklist</h3>
            <ul class="checklist" id="checklist">
                <li id="check-spreadsheet">üìä Google Spreadsheet created</li>
                <li id="check-script">üîß Google Apps Script created and configured</li>
                <li id="check-deploy">üöÄ Script deployed with "Anyone" access</li>
                <li id="check-url">üîó Web App URL copied</li>
                <li id="check-connection">‚úÖ Connection test passed</li>
                <li id="check-submission">üìù Form submission test passed</li>
            </ul>
        </div>

        <div class="step">
            <h3>üîß Common Issues & Solutions</h3>
            <p><strong>CORS Errors:</strong> Make sure "Who has access" is set to <span class="code">Anyone</span> (not "Anyone with Google account")</p>
            <p><strong>404 Errors:</strong> Check that your Web App URL is correct and the deployment is active</p>
            <p><strong>No Data Saved:</strong> Verify your Spreadsheet ID is correct in the Apps Script</p>
        </div>
    </div>

    <script>
        let scriptUrl = '';

        function addResult(message, type = 'info', timestamp = true) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            
            const time = timestamp ? `<strong>${new Date().toLocaleTimeString()}</strong>: ` : '';
            div.innerHTML = time + message;
            
            results.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function updateChecklist(itemId, passed) {
            const item = document.getElementById(itemId);
            if (item) {
                const icon = passed ? '<span class="check">‚úÖ</span>' : '<span class="cross">‚ùå</span>';
                item.innerHTML = icon + ' ' + item.textContent.replace(/^[‚úÖ‚ùå]\s*/, '');
            }
        }

        function getScriptUrl() {
            const input = document.getElementById('scriptUrl');
            scriptUrl = input.value.trim();
            
            if (!scriptUrl) {
                addResult('‚ùå Please enter your Google Apps Script Web App URL', 'error');
                return false;
            }
            
            if (!scriptUrl.includes('script.google.com') || !scriptUrl.endsWith('/exec')) {
                addResult('‚ö†Ô∏è URL format looks incorrect. Should be: https://script.google.com/macros/s/.../exec', 'warning');
            }
            
            return true;
        }

        async function testConnection() {
            if (!getScriptUrl()) return;
            
            addResult('üîÑ Testing connection to Google Apps Script...', 'info');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(scriptUrl, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache',
                    credentials: 'omit',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    addResult(`‚úÖ Connection successful! ${data.message}`, 'success');
                    
                    if (data.corsEnabled) {
                        addResult('‚úÖ CORS headers are properly configured', 'success');
                    }
                    
                    updateChecklist('check-connection', true);
                    return true;
                } else {
                    addResult(`‚ùå Connection failed with status: ${response.status}`, 'error');
                    addResult('üí° Check that your script is deployed with "Anyone" access', 'warning');
                    updateChecklist('check-connection', false);
                    return false;
                }
                
            } catch (error) {
                addResult(`‚ùå Connection error: ${error.message}`, 'error');
                
                if (error.message.includes('CORS')) {
                    addResult('üí° CORS Error: Make sure "Who has access" is set to "Anyone" in your deployment settings', 'error');
                } else if (error.name === 'AbortError') {
                    addResult('üí° Request timed out. Check your internet connection and script URL', 'warning');
                }
                
                updateChecklist('check-connection', false);
                return false;
            }
        }

        async function testSubmission() {
            if (!getScriptUrl()) return;
            
            addResult('üìù Testing form submission...', 'info');
            
            const testData = {
                fullName: 'Test User',
                email: 'test@example.com',
                phone: '+44 7700 900123',
                streetAddress: '123 Test Street',
                city: 'London',
                postcode: 'SW1A 1AA',
                comments: 'This is a test submission from the verification tool.'
            };
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    credentials: 'omit',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        addResult(`‚úÖ Form submission successful! Data saved to row ${data.rowNumber}`, 'success');
                        addResult('üéâ Your form is working perfectly! No CORS issues detected.', 'success');
                        updateChecklist('check-submission', true);
                        return true;
                    } else {
                        addResult(`‚ùå Submission failed: ${data.message}`, 'error');
                        updateChecklist('check-submission', false);
                        return false;
                    }
                } else {
                    addResult(`‚ùå Submission failed with status: ${response.status}`, 'error');
                    updateChecklist('check-submission', false);
                    return false;
                }
                
            } catch (error) {
                addResult(`‚ùå Submission error: ${error.message}`, 'error');
                
                if (error.message.includes('CORS')) {
                    addResult('üí° CORS Error: Your Apps Script deployment needs to be fixed', 'error');
                }
                
                updateChecklist('check-submission', false);
                return false;
            }
        }

        async function runFullTest() {
            if (!getScriptUrl()) return;
            
            addResult('üöÄ Running full verification test...', 'info');
            
            // Clear previous results
            document.getElementById('results').innerHTML = '';
            
            // Test connection first
            const connectionOk = await testConnection();
            
            if (connectionOk) {
                // Wait a moment then test submission
                setTimeout(async () => {
                    const submissionOk = await testSubmission();
                    
                    if (connectionOk && submissionOk) {
                        addResult('üéâ All tests passed! Your setup is working perfectly!', 'success');
                        addResult('‚úÖ You can now use your form without any CORS issues', 'success');
                    }
                }, 1000);
            } else {
                addResult('‚ùå Connection test failed. Please fix the connection issues before testing submissions.', 'error');
            }
        }

        // Auto-focus URL input
        document.getElementById('scriptUrl').focus();
        
        // Add enter key support
        document.getElementById('scriptUrl').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                testConnection();
            }
        });
    </script>
</body>
</html>